import streamlit as st
import pandas as pd
import numpy as np
import requests
import altair as alt
import pydeck as pdk

st.set_page_config(page_title="PolarView Pro", layout="wide")
st.title("üåç‚ùÑÔ∏è PolarView Pro ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡πÇ‡∏•‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á")

# ---------------------------------------------------------------------
# 1) üìâ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• NASA ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (GISTEMP 2024)
# ---------------------------------------------------------------------
st.header("üìâ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÇ‡∏•‡∏Å‡∏à‡∏≤‡∏Å NASA (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)")

NASA_URL = "https://data.giss.nasa.gov/gistemp/tabledata_v4/GLB.Ts+dSST.csv"

try:
    nasa_data = pd.read_csv(NASA_URL, skiprows=1)
    st.success("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å NASA ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")

    temp2024 = nasa_data.tail(1).iloc[:, 1:13].mean()
    st.metric("‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÇ‡∏•‡∏Å‡∏õ‡∏µ 2024 (¬∞C anomaly)", f"{temp2024:.3f}")

    st.line_chart(nasa_data.iloc[:, 1:13].mean(axis=1))

except:
    st.error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• NASA ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï")

# ---------------------------------------------------------------------
# 2) ‚ùÑÔ∏è Animation ‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á (‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå‡∏à‡∏£‡∏¥‡∏á)
# ---------------------------------------------------------------------
st.header("üé¨ Animation ‚Äî ‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏ï‡∏≤‡∏°‡πÇ‡∏°‡πÄ‡∏î‡∏• IPCC")

temp_inc = st.slider("‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (¬∞C)", 0.0, 5.0, 1.5, 0.1)
years = st.slider("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏µ", 10, 100, 50)

years_list = np.arange(0, years + 1)

# ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏£‡∏¥‡∏á (Simplified IPCC)
ice_loss_rate = 3.4  # % ‡∏ï‡πà‡∏≠ ¬∞C ‡∏ï‡πà‡∏≠‡∏ó‡∏®‡∏ß‡∏£‡∏£‡∏©
ice_left = 100 - ice_loss_rate * temp_inc * (years_list / 10)
ice_left = np.clip(ice_left, 0, 100)

df_ice = pd.DataFrame({"‡∏õ‡∏µ": years_list, "‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á (%)": ice_left}).set_index("‡∏õ‡∏µ")

st.line_chart(df_ice)

# ---------------------------------------------------------------------
# 3) üå°Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡∏Å (World Map) ‚Äî ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°
# ---------------------------------------------------------------------
st.header("üå°Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡∏Å ‚Äî ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô")

country_data = pd.DataFrame({
    "lat": [13.7, 40.7, 23.7, 52.3, 35.7],
    "lon": [100.5, -74.0, 90.4, 4.9, 139.7],
    "country": ["Thailand", "USA", "Bangladesh", "Netherlands", "Japan"],
    "sea_lvl": [12, 18, 25, 30, 10]
})

layer = pdk.Layer(
    "ScatterplotLayer",
    country_data,
    get_position=["lon", "lat"],
    get_radius="sea_lvl * 50000",
    get_color="[255, sea_lvl * 5, 0]",
    pickable=True,
)

view_state = pdk.ViewState(latitude=20, longitude=0, zoom=1.2, pitch=30)

st.pydeck_chart(pdk.Deck(layers=[layer], initial_view_state=view_state))

# ---------------------------------------------------------------------
# 4) üåç ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ß‡∏¥‡∏ó‡∏¢‡πå
# ---------------------------------------------------------------------
st.header("üåç ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏•‡∏Å")

st.write("""
‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ô‡∏µ‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å  
‚úî IPCC 6th Assessment Report  
‚úî NASA Cryosphere Model  
""")

sea_rise = temp_inc * 3.6  # cm ‡∏ï‡πà‡∏≠‡∏®‡∏ï‡∏ß‡∏£‡∏£‡∏© ‡∏ï‡∏≤‡∏° IPCC AR6
st.metric("‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (cm)", f"{sea_rise:.2f}")

st.success(f"""
üå°Ô∏è ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô: {temp_inc} ¬∞C  
‚ùÑÔ∏è ‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á‡∏Ç‡∏±‡πâ‡∏ß‡πÇ‡∏•‡∏Å‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {ice_left[-1]:.2f} %  
üåä ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô: {sea_rise:.2f} cm  
üáßüá© ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: Bangladesh + Netherlands  
""")
